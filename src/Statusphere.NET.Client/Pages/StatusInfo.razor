@page "/statusinfo"
@using Microsoft.AspNetCore.SignalR.Client
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@implements IAsyncDisposable

<StatusTimeline Statuses="Statuses" />

@code {
    private HubConnection HubConnection { get; set; } = null!;

    private List<StatusDto> Statuses { get; set; } = new List<StatusDto>();

    [Inject]
    private HttpClient HttpClient { get; set; } = null!;

    [Inject]
    private NavigationManager NavigationManager { get; set; } = null!;

    public ValueTask DisposeAsync()
    {
        if (HubConnection is null)
            return ValueTask.CompletedTask;

        return HubConnection.DisposeAsync();
    }

    protected override async Task OnInitializedAsync()
    {
        await ConnectAsync();

        Statuses = (await HttpClient.GetFromJsonAsync<List<StatusDto>>("api/statuses"))!;
    }

    private async Task ConnectAsync()
    {
        HubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/status"))
            .WithAutomaticReconnect()
            .Build();

        HubConnection.On<StatusDto>("StatusCreated", (dto) =>
        {
            Statuses.Add(dto);
            StateHasChanged();
        });

        await HubConnection.StartAsync();
    }
}
